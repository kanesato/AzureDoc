# MDfC セットアップ

各サブスクリプションで、MDfC (Microsoft Defender for Cloud)の機能を有効化します。スクリプトからの有効化・自動化が困難なところがあるため、本作業はポータルから手作業で実施してください。ポイントは以下の通りです。具体的な操作手順が必要な場合はデモビテオを参照してください。

- 各サブスクリプションで、MDfC の有効化を行う
  - LAW を集約型にするため、AMA 関連の自動プロビジョニング機能は無効化し、手動でセットアップする
- 連続エクスポートの設定を書き出しておくためのリソースグループを各サブスクリプションに作成
  - 設定には各サブスクリプションの owner 権限が必要、サブスクリプションの新規作成時に下記をまとめて行うようなフローを設計しておくことが望ましい。
  - 本サンプルでは簡単のため、admin アカウントを使ってまとめて設定してしまうことにする。
- 各サブスクリプションの環境設定を開き、以下を行う
  - ① CSPM、CWP 機能をすべて有効化したのち、自動プロビジョニング設定で LAA/AMA の自動インストールのみ無効化する
  - ② 電子メールの通知を有効化
  - ③ 連続エクスポート機能の有効化（事前に作成しておいた rg-security-{MAIN_LOCATION} リソースグループに設定を保存しておくようにする）
- さらに管理サブスクリプション内の LAW に対して、以下を設定する
  - ④ サーバ、SQL サーバの CSPM 機能を有効化
  - ⑤ すべてのセキュリティイベントの収集を有効化
- すべてのプランが有効化されていれば OK

なお大規模な Azure 共通基盤の本番運用では、管理グループへの Azure Policy の手動割り当てなどを行いますが、これについては一通りの環境構築が終わった後、セクション 11 にて詳細に解説します。ここでは MDfC をデフォルトの機能範囲で有効化して利用する、という形で設定してください。

![picture 1](./images/2b4dace2237767edf34c626a060d2740e65fb3a5b09d2741acd10bfc5734ec20.png)  

![picture 2](./images/7519f5404a45bf638f73e3c5356684b9dd9df27ed8caa1c9d5c691263a3cacd6.png)  

![picture 3](./images/46b3885fdae215eb2c6e9749ed6afa48e88763351a6d05e296133481b789e5c7.png)  

![picture 4](./images/20e646d314736e42a70e062ec666bf5a707a8db5ad1db085abd628128dc2376f.png)  

![picture 5](./images/a34b81c171122eeee9c04ef36db6695b2766dc44d5c925b7041c42ce5ef4d68b.png)  

![picture 6](./images/3552289019ebf3d9f0a19a8ad8c9daac8b7c8911b979be7753173f63a6ae5dd2.png)  

![picture 7](./images/dd2e1afd66e1202c5de1b7719f22e6cae5f64ffc3b3479d00f8b6aeba1f377cc.png)  
