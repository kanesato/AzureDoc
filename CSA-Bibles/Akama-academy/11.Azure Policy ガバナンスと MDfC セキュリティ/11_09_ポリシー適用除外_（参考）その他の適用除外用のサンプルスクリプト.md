# ポリシー適用除外 : （参考）その他の適用除外用のサンプルスクリプト

**今回は利用しませんが**、よく利用されると思われる適用除外用のサンプルスクリプトをいくつか示します。必要な場合にカスタマイズしてご利用ください。

```bash
 
# ■ MFA 適用を免除（※ テスト目的の場合のみ）
 
###########################
# 特定アカウントのみ免除する場合は以下
for TEMP_SUBSCRIPTION_ID in $SUBSCRIPTION_IDS; do
 
TEMP_RESOURCE_ID="/subscriptions/${TEMP_SUBSCRIPTION_ID}"
 
for TEMP_POLICY_REF_ID in "identityEnableMFAForOwnerPermissionsMonitoring" "identityEnableMFAForOwnerPermissionsMonitoringNew" "identityEnableMFAForWritePermissionsMonitoring" "identityEnableMFAForWritePermissionsMonitoringEffect" "identityEnableMFAForReadPermissionsMonitoring" "identityEnableMFAForReadPermissionsMonitoringNew" ; do
 
TEMP_EXEMPTION_ID=$(uuidgen --sha1 --namespace @oid --name "${TEMP_RESOURCE_ID}_${TEMP_POLICY_REF_ID}_${TEMP_ASSIGNMENT_ID}")
az policy exemption create \
	--name "${TEMP_EXEMPTION_ID}" \
	--exemption-category Mitigated \
	--policy-definition-reference-ids "${TEMP_POLICY_REF_ID}" \
	--scope ${TEMP_RESOURCE_ID} \
	--policy-assignment "${TEMP_ASSIGNMENT_ID}"
done
done
###########################
 
 
# ■ Cloud Shell 用のストレージに対するネットワークセキュリティ確保の適用免除
# Cloud Shell 用のストレージに対しては適用を免除
 
# Storage accounts should restrict network access using virtual network rules
# /providers/Microsoft.Authorization/policyDefinitions/2a1a9cdf-e04d-429a-8416-3bfb72a1b26f
# storageAccountsShouldRestrictNetworkAccessUsingVirtualNetworkRulesMonitoringEffect
# Storage accounts should use private link
# /providers/Microsoft.Authorization/policyDefinitions/6edd7eda-6dd8-40f7-810d-67160c639cd9
# storageAccountShouldUseAPrivateLinkConnectionMonitoringEffect
# [Preview]: Storage account public access should be disallowed
# /providers/Microsoft.Authorization/policyDefinitions/4fa4b6c0-31ca-4c0d-b10d-24b96f62a751
# StorageDisallowPublicAccess
# Storage accounts should restrict network access
# /providers/Microsoft.Authorization/policyDefinitions/34c877ad-507e-4c82-993e-3452a6e0ad3c
# disableUnrestrictedNetworkToStorageAccountMonitoring
 
TEMP_EXEMPTION_NAME="Test-Exemption-CloudShell"
cat > temp.json << EOF
{
  "properties": {
    "policyAssignmentId": "${TEMP_ASSIGNMENT_ID}",
    "policyDefinitionReferenceIds": [
      "storageAccountsShouldRestrictNetworkAccessUsingVirtualNetworkRulesMonitoringEffect",
      "storageAccountShouldUseAPrivateLinkConnectionMonitoringEffect",   
      "StorageDisallowPublicAccess",
      "disableUnrestrictedNetworkToStorageAccountMonitoring"
    ],
    "exemptionCategory": "Mitigated",
    "displayName": "テスト目的での免除 - Cloud Shell の検査を免除",
    "description": "テスト目的での免除 - Cloud Shell の検査を免除",
    "metadata": {
      "reason": "テストのため"
    }
  }
}
EOF
 
# 以下は要修正
TEMP_RESOURCE_ID="/subscriptions/903c6183-3adc-4577-9114-b3fef417ff28/resourcegroups/cloud-shell-storage-southeastasia/providers/microsoft.storage/storageaccounts/cs11003200268ab0a3c"
az rest --method PUT --uri "${TEMP_RESOURCE_ID}/providers/Microsoft.Authorization/policyExemptions/${TEMP_EXEMPTION_NAME}?api-version=2022-07-01-preview" --body @temp.json
 
 
```
